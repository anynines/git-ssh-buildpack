#!/usr/bin/env bash

echo "---> Git SSH key buildpack"

set -eo pipefail

env_dir="$2/env"

if [[ -f "$env_dir/GIT_SSH_KEY" ]]; then
  echo "Found GIT_SSH_KEY adding to ssh-agent"
  eval $(ssh-agent -s) >/dev/null 2>&1
  git config --global url."git@github.com:".insteadOf "https://github.com/"
  GIT_SSH_KEY=`cat $env_dir/GIT_SSH_KEY`
  echo -e "$GIT_SSH_KEY\n" | ssh-add -
  ssh -o StrictHostKeyChecking=accept-new git@github.com || true
  build_env_dir="$1/ssh-agent/env.build"
  mkdir -p $build_env_dir
  echo -n "$SSH_AUTH_SOCK" > "$build_env_dir/SSH_AUTH_SOCK"
  echo -n "$SSH_AGENT_PID" > "$build_env_dir/SSH_AGENT_PID"
  echo "build = true" > "$1/ssh-agent.toml"
fi
